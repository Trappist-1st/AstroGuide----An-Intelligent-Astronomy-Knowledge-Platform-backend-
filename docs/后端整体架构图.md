# AstroGuide 后端整体架构图（当前实现）

> 目标：用一张图看清“请求如何进来 → SSE 如何流式输出 → Spring AI 如何托管 Tool Calling → 资料摄入与数据/外部依赖在哪里”。

## 1) 组件视图（Component / Container）

```mermaid
flowchart TB
  %% ========== Client ==========
  Client["前端 Web / EventSource
(如 localhost:5173)"] -->|"POST 会话/消息, GET stream, POST ingest"| API

  %% ========== CORS ==========
  CorsFilter["CorsFilter
app.cors.allowed-origins"]

  %% ========== API Layer ==========
  subgraph API[Controller 层]
    ConversationController["ConversationController
POST/GET /conversations"]
    MessageController["MessageController
POST .../messages"]
    AIChatController["AIChatController
GET .../messages/:messageId/stream"]
    IngestController["IngestController
POST /ingest/file, /ingest/text"]
    ConceptCardsController["ConceptCardsController
GET /concepts/lookup"]
  end

  Client --> CorsFilter
  CorsFilter --> API

  MessageController --> MessageService
  ConversationController --> ConversationService
  AIChatController --> Orchestrator
  IngestController --> IngestService
  ConceptCardsController --> ConceptCardService

  %% ========== Orchestrator ==========
  subgraph Orchestration[编排层]
    Orchestrator["ChatStreamOrchestrator
- 鉴权/会话校验
- 限流 RateLimitPolicy
- prime ChatMemory(从 MySQL)
- 组装 systemPrompt（含能答边界/Wikipedia 提示）
- 拼 SSE: meta/delta/done/error
- 落库 assistant + usage"]
    RateLimitPolicy[RateLimitPolicy]
    OutputLimitPolicy[OutputLimitPolicy]
    ContextTrimPolicy[ContextTrimPolicy]
  end

  Orchestrator -->|"streamChatClientResponses(...)"| ChatStreamService
  Orchestrator --> ConversationService
  Orchestrator --> MessageService
  Orchestrator --> UsageService

  %% ========== Service ==========
  subgraph Service[服务层]
    ChatStreamService[ChatStreamService]
    ChatStreamServiceImpl["ChatStreamServiceImpl
Spring AI ChatClient
RAG 自定义 prompt 模板"]
    ConversationService[ConversationService]
    MessageService[MessageService]
    UsageService[UsageService]
    IngestService["IngestService
解析→分块→VectorStore.add"]
    WikipediaService[WikipediaService]
    ConceptCardService[ConceptCardService]
  end

  ChatStreamService --> ChatStreamServiceImpl

  %% ========== Ingest 管道 ==========
  subgraph Ingest[资料摄入]
    DocumentParser["DocumentParserService
PDF/EPUB/TXT/MD"]
    TextChunker[TextChunker
按句分块]
  end
  IngestService --> DocumentParser
  IngestService --> TextChunker
  IngestService --> VectorStore

  %% ========== Spring AI ==========
  subgraph SpringAI[Spring AI]
    ChatClient["ChatClient
.prompt().advisors().tools().stream()"]
    MemoryAdvisor[MessageChatMemoryAdvisor]
    RagAdvisor["QuestionAnswerAdvisor
VectorStore + 自定义 RAG 模板"]
    WikiTool["WikipediaTool
@Tool search_wikipedia"]
    KbTool["KnowledgeBaseTool
@Tool search_knowledge_base"]
    CardTool["ConceptCardTool
@Tool lookup_concept_card"]
  end

  ChatStreamServiceImpl --> ChatClient
  ChatClient --> MemoryAdvisor
  ChatClient --> RagAdvisor
  ChatClient --> WikiTool
  ChatClient --> KbTool
  ChatClient --> CardTool

  %% ========== Data Stores / External ==========
  subgraph Data[数据与外部依赖]
    MySQL[("MySQL
conversations / messages
request_usage / term_cache")]
    Qdrant[(Qdrant VectorStore
astro_knowledge)]
    LLM[("OpenAI 兼容 Chat API
DeepSeek/硅基流动等")]
    WikipediaAPI[(Wikipedia API)]
  end

  ConversationService --> MySQL
  MessageService --> MySQL
  UsageService --> MySQL
  ConceptCardService --> MySQL
  RagAdvisor --> Qdrant
  ChatClient --> LLM
  WikiTool --> WikipediaService --> WikipediaAPI
  KbTool --> Qdrant
  CardTool --> ConceptCardService
  VectorStore[VectorStore] --> Qdrant

  %% ========== Config ==========
  subgraph Config[关键配置（application.yaml）]
    CorsOrigins["app.cors.allowed-origins
默认 localhost:5173"]
    ToolsEnabled["app.ai.tools.enabled
true: 注册 tools"]
    RagEnabled[app.rag.enabled]
    IngestChunk["app.ingest.chunk-size
chunk-overlap"]
  end

  CorsOrigins -.-> CorsFilter
  ToolsEnabled -.-> ChatStreamServiceImpl
  RagEnabled -.-> RagAdvisor
  IngestChunk -.-> TextChunker
```

## 2) 主链路时序图（会话 → 提交消息 → SSE 流式 + Tool Calling）

```mermaid
sequenceDiagram
  autonumber
  participant FE as 前端(EventSource)
  participant Conv as ConversationController
  participant Msg as MessageController
  participant C as AIChatController
  participant O as ChatStreamOrchestrator
  participant DB as MySQL
  participant S as ChatStreamServiceImpl
  participant AI as Spring AI ChatClient
  participant LLM as OpenAI兼容Chat API
  participant VT as VectorStore(Qdrant)
  participant W as Wikipedia API
  participant CC as ConceptCardService

  FE->>Conv: POST /conversations (X-Client-Id)
  Conv->>DB: 创建会话
  Conv-->>FE: conversationId

  FE->>Msg: POST .../messages (content, difficulty, language)
  Msg->>DB: 写入 user 消息 + assistant 占位(queued)
  Msg-->>FE: messageId, streamUrl

  FE->>C: GET streamUrl (X-Client-Id)
  C->>O: stream(conversationId, messageId, clientId)
  O->>DB: 校验会话/取 user message
  O->>DB: prime ChatMemory(历史消息)
  O-->>FE: SSE meta

  O->>S: streamChatClientResponses(systemPrompt, userText)
  S->>AI: prompt().system().user()
  S->>AI: advisors(MessageChatMemory, QuestionAnswer 若 RAG 且有检索结果)
  Note over S: RAG 使用自定义 prompt 模板（上下文未覆盖时可通用知识补充）
  alt app.ai.tools.enabled=true
    S->>AI: tools(WikipediaTool, KnowledgeBaseTool, ConceptCardTool)
  end

  AI->>LLM: 流式请求(带 advisors + tools 上下文)

  alt 模型触发 search_knowledge_base
    AI->>VT: similaritySearch(query, topK)
    VT-->>AI: docs
    AI->>LLM: 回填 tool 结果并继续生成
  end

  alt 模型触发 search_wikipedia
    AI->>W: 查询摘要/段落
    W-->>AI: extracts
    AI->>LLM: 回填 tool 结果并继续生成
  end

  alt 模型触发 lookup_concept_card
    AI->>CC: lookup(type, lang, key, text)
    CC-->>AI: ConceptCardResponse
    AI->>LLM: 回填 tool 结果并继续生成
  end

  loop token streaming
    LLM-->>AI: delta
    AI-->>S: ChatClientResponse(delta)
    S-->>O: ChatClientResponse(delta)
    O-->>FE: SSE delta
  end

  O->>DB: 落库 assistant + usage
  O-->>FE: SSE done (usage + citations)
```

## 3) 你在代码里看“主链路”的推荐入口

- **API 入口**：
  - 会话：ConversationController（POST/GET /api/v0/conversations）
  - 消息：MessageController（POST .../messages）
  - SSE 流：AIChatController（GET .../messages/{messageId}/stream）
  - 资料摄入：IngestController（POST /api/v0/ingest/file, /ingest/text）
  - 概念卡：ConceptCardsController（GET /api/v0/concepts/lookup）
- **编排**（SSE、落库、usage/citations）：`ai/orchestrator/ChatStreamOrchestrator.java`
- **Spring AI**（advisors + 自定义 RAG 模板、tools 注册）：`service/impl/ChatStreamServiceImpl.java`
- **Tools**：`ai/tools/WikipediaTool.java`、`KnowledgeBaseTool.java`、`ConceptCardTool.java`
- **资料摄入**：`service/IngestService.java`、`ingest/parser/`、`ingest/TextChunker.java`
- **跨域**：`config/CorsConfig.java`（CorsFilter，app.cors.allowed-origins）

> 备注：SSE 不额外输出 tool_call/tool_result 过程事件；RAG 使用自定义 prompt 模板，上下文未覆盖时允许模型用通用知识补充并标注来源。
