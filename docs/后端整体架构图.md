# AstroGuide 后端整体架构图（当前实现）

> 目标：用一张图看清“请求如何进来 → SSE 如何流式输出 → Spring AI 如何托管 Tool Calling → 数据/外部依赖在哪里”。

## 1) 组件视图（Component / Container）

```mermaid
flowchart TB
  %% ========== Client ==========
  Client["前端 Web / EventSource"] -->|"SSE GET /api/v0/conversations/:conversationId/messages/:messageId/stream"| AIChatController

  %% ========== API Layer ==========
  subgraph API[Controller 层]
    AIChatController["AIChatController
SSE 入口"]
  end

  %% ========== Orchestrator ==========
  AIChatController --> Orchestrator
  subgraph Orchestration[编排层]
    Orchestrator["ChatStreamOrchestrator
- 鉴权/会话校验
- 限流 RateLimitPolicy
- prime ChatMemory(从MySQL)
- 组装 systemPrompt
- 拼 SSE: meta/delta/done/error
- 落库 assistant + usage"]

    RateLimitPolicy[RateLimitPolicy]
    OutputLimitPolicy[OutputLimitPolicy]
    ContextTrimPolicy[ContextTrimPolicy]
  end

  Orchestrator -->|"streamChatClientResponses(...)"| ChatStreamService

  %% ========== Service ==========
  subgraph Service[服务层]
    ChatStreamService[ChatStreamService]
    ChatStreamServiceImpl["ChatStreamServiceImpl
Spring AI ChatClient"]

    ConversationService[ConversationService]
    MessageService[MessageService]
    UsageService[UsageService]

    WikipediaService[WikipediaService]
    ConceptCardService[ConceptCardService]
  end

  Orchestrator --> ConversationService
  Orchestrator --> MessageService
  Orchestrator --> UsageService

  ChatStreamService --> ChatStreamServiceImpl

  %% ========== Spring AI ==========
  subgraph SpringAI[Spring AI]
    ChatClient["ChatClient
.prompt().advisors().tools().stream()"]

    MemoryAdvisor[MessageChatMemoryAdvisor]
    RagAdvisor["QuestionAnswerAdvisor
(VectorStore)"]
    WikiAdvisor["WikipediaOnDemandAdvisor
(可选, tools关闭时)"]

    WikiTool["WikipediaTool
@Tool search_wikipedia"]
    KbTool["KnowledgeBaseTool
@Tool search_knowledge_base"]
    CardTool["ConceptCardTool
@Tool lookup_concept_card"]
  end

  ChatStreamServiceImpl --> ChatClient
  ChatClient --> MemoryAdvisor
  ChatClient --> RagAdvisor
  ChatClient --> WikiAdvisor
  ChatClient --> WikiTool
  ChatClient --> KbTool
  ChatClient --> CardTool

  %% ========== Data Stores / External ==========
  subgraph Data[数据与外部依赖]
    MySQL[("MySQL
conversations/messages/request_usage
+ concept card cache等")]
    Qdrant[(Qdrant VectorStore)]
    LLM[("OpenAI兼容 Chat API
DeepSeek/硅基流动等")]
    WikipediaAPI[(Wikipedia API)]
  end

  ConversationService --> MySQL
  MessageService --> MySQL
  UsageService --> MySQL
  ConceptCardService --> MySQL

  RagAdvisor --> Qdrant
  ChatClient --> LLM

  WikiTool --> WikipediaService --> WikipediaAPI
  KbTool --> Qdrant
  CardTool --> ConceptCardService

  %% ========== Switches ==========
  subgraph Config[关键开关（application.yaml）]
    ToolsEnabled["app.ai.tools.enabled
true: 注册 tools
false: 不注册 tools"]
    RagEnabled[app.rag.enabled]
    WikiOnDemandEnabled["app.rag.wikipedia-on-demand.enabled
(仅 tools 关闭时更常用)"]
  end

  ToolsEnabled -.-> ChatStreamServiceImpl
  RagEnabled -.-> RagAdvisor
  WikiOnDemandEnabled -.-> WikiAdvisor
```

## 2) 主链路时序图（SSE Streaming + Tool Calling）

```mermaid
sequenceDiagram
  autonumber
  participant FE as 前端(EventSource)
  participant C as AIChatController
  participant O as ChatStreamOrchestrator
  participant DB as MySQL
  participant S as ChatStreamServiceImpl
  participant AI as Spring AI ChatClient
  participant LLM as OpenAI兼容Chat API
  participant VT as VectorStore(Qdrant)
  participant W as Wikipedia API
  participant CC as ConceptCardService

  FE->>C: GET /stream (X-Client-Id)
  C->>O: stream(conversationId, messageId, clientId)
  O->>DB: 校验会话/取 user message
  O->>DB: prime ChatMemory(历史消息)
  O-->>FE: SSE meta

  O->>S: streamChatClientResponses(...)
  S->>AI: prompt().system().user()
  S->>AI: advisors(Memory, RAG?, WikiAdvisor?)
  alt app.ai.tools.enabled=true
    S->>AI: tools(WikipediaTool, KnowledgeBaseTool, ConceptCardTool)
  end

  AI->>LLM: 流式请求(带tools+advisors上下文)

  alt 模型触发 search_knowledge_base
    AI->>VT: similaritySearch(query, topK)
    VT-->>AI: docs/citations
    AI->>LLM: 回填tool结果并继续生成
  end

  alt 模型触发 search_wikipedia
    AI->>W: 查询摘要/段落
    W-->>AI: extracts
    AI->>LLM: 回填tool结果并继续生成
  end

  alt 模型触发 lookup_concept_card
    AI->>CC: lookup(type, lang, key, text)
    CC-->>AI: ConceptCardResponse
    AI->>LLM: 回填tool结果并继续生成
  end

  loop token streaming
    LLM-->>AI: delta
    AI-->>S: ChatClientResponse(delta)
    S-->>O: ChatClientResponse(delta)
    O-->>FE: SSE delta
  end

  O->>DB: 落库 assistant + usage
  O-->>FE: SSE done (usage + citations[Advisor来源])
```

## 3) 你在代码里看“主链路”的推荐入口

- SSE 入口：src/main/java/com/imperium/astroguide/controller/AIChatController.java
- 编排（SSE、落库、usage/citations）：src/main/java/com/imperium/astroguide/ai/orchestrator/ChatStreamOrchestrator.java
- Spring AI 调用点（advisors/tools 注册）：src/main/java/com/imperium/astroguide/service/impl/ChatStreamServiceImpl.java
- Tools：
  - src/main/java/com/imperium/astroguide/ai/tools/WikipediaTool.java
  - src/main/java/com/imperium/astroguide/ai/tools/KnowledgeBaseTool.java
  - src/main/java/com/imperium/astroguide/ai/tools/ConceptCardTool.java

> 备注：当前实现为了“干净稳定”，SSE 不额外输出 tool_call/tool_result 过程事件；如你希望前端看到工具调用过程，我们可以在下一步加“可选的观测增强（日志/拦截/自定义事件）”。
